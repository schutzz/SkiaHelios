# rules/triage_rules.yaml [Themis Law v2.2]
# Update: Fixed Noise Filter placement & Enhanced folder suppression

# --- [Persistence Targets (AION Scope)] ---
persistence_targets:
  - name: "Run Keys"
    category: "Registry"
    pattern: "Microsoft\\\\Windows\\\\CurrentVersion\\\\Run"
  
  - name: "RunOnce Keys"
    category: "Registry"
    pattern: "Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce"

  - name: "Services"
    category: "Registry"
    pattern: "Services"

  - name: "Scheduled Tasks"
    category: "Registry"
    pattern: "ScheduledTasks"

# ==========================================
# ğŸ› ï¸ Dual-Use / Admin Tools Configuration (Expanded)
# ==========================================
# æ”»æ’ƒè€…ã«ã‚‚ç®¡ç†è€…ã«ã‚‚ä½¿ã‚ã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ç¾¤ã€‚
# ã“ã‚Œã‚‰ã¯ã€Œãƒã‚¤ã‚ºã¨ã—ã¦æ¶ˆå»ã›ãšã€ã€å¿…ãšå ±å‘Šæ›¸ï¼ˆLachesisï¼‰ã®ãƒªã‚¹ãƒˆã«åŠ ãˆã¾ã™ã€‚
dual_use_tools:
  # [1] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ã‚­ãƒ£ãƒ³ & åµå¯Ÿ
  - name: "Network Scanner"
    keywords: 
      - "nmap"
      - "zenmap"
      - "masscan"
      - "angryip"
      - "advanced_ip_scanner"
      - "netscan"
    noise_paths: ["nmap/scripts", "nmap/nselib", "nmap/docs"]

  # [2] ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ & è§£æ
  - name: "Packet Capture"
    keywords: 
      - "wireshark"
      - "tshark"
      - "capinfos"
      - "tcpdump"
      - "windump"
      - "winpcap"
      - "npcap"
    noise_paths: ["wireshark/snmp", "wireshark/radius", "wireshark/help", "wireshark/dtds", "wireshark/profiles"]

  # [3] ãƒªãƒ¢ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹ & æ¨ªå±•é–‹ (Lateral Movement)
  - name: "Remote Admin / Lateral"
    keywords: 
      - "psexec"
      - "paexec"
      - "winscp"
      - "putty"
      - "plink"      # Puttyã®CUIç‰ˆï¼ˆãƒˆãƒ³ãƒãƒªãƒ³ã‚°ã«ã‚ˆãä½¿ã‚ã‚Œã‚‹ï¼‰
      - "teamviewer" # æ­£è¦RATã¨ã—ã¦æ‚ªç”¨å¤šã—
      - "anydesk"
      - "logmein"
      - "screenconnect"
      - "radmin"
      - "vnc"        # RealVNC, TightVNC, UltraVNC
      - "mstsc"      # RDP (ãƒ­ã‚°ã«æ®‹ã‚‹ã“ã¨ã¯ç¨€ã ãŒå¿µã®ãŸã‚)
    noise_paths: ["teamviewer/version", "anydesk/ad_printer"]

  # [4] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ„ãƒ¼ãƒ« & ãƒˆãƒ³ãƒãƒªãƒ³ã‚°
  - name: "Net Tool / Tunneling"
    keywords: 
      - "netcat"
      - "nc.exe"
      - "ncat"
      - "socat"
      - "ngrok"      # å¤–éƒ¨å…¬é–‹ãƒ„ãƒ¼ãƒ«
      - "frp"        # Fast Reverse Proxy (æ”»æ’ƒè€…å¾¡ç”¨é”)
      - "chisel"
      - "termite"
      - "proxifier"
    noise_paths: []

  # [5] Active Directory åµå¯Ÿ & èªè¨¼æƒ…å ±çªƒå–
  - name: "Recon / Credential"
    keywords: 
      - "adfind"     # ADæƒ…å ±åé›†ã®å®šç•ª
      - "bloodhound"
      - "sharphound"
      - "powerview"
      - "mimikatz"
      - "lazagne"    # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¾©å…ƒãƒ„ãƒ¼ãƒ«
      - "procdump"   # LSASSãƒ€ãƒ³ãƒ—ã«æ‚ªç”¨ã•ã‚Œã‚‹æ­£è¦ãƒ„ãƒ¼ãƒ«
      - "hashcat"
      - "john"       # John the Ripper
    noise_paths: []

  # [6] ãƒ‡ãƒ¼ã‚¿æŒã¡å‡ºã— (Exfiltration) & åœ§ç¸®
  - name: "Exfiltration / Archiver"
    keywords: 
      - "rclone"     # ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®è»¢é€ã«ã‚ˆãä½¿ã‚ã‚Œã‚‹
      - "megasync"
      - "7za.exe"    # 7-Zipã®CUIç‰ˆ
      - "rar.exe"    # WinRARã®CUIç‰ˆ
      - "winrar"
    noise_paths: []

  # [7] åŒ¿ååŒ– & Webã‚¢ã‚¯ã‚»ã‚¹
  - name: "Anonymity / Tor"
    keywords: 
      - "tor.exe"
      - "tor browser"
      - "onion"
    noise_paths: ["tor/pluggabletransports", "browser/torbrowser/data"]

  # [8] é–‹ç™ºè¨€èª & ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ (ç’°å¢ƒå¯„ç”Ÿå‹æ”»æ’ƒ)
  - name: "Dev / Scripting"
    keywords: 
      - "python"
      - "pip"
      - "perl"
      - "ruby"
      - "lua"
      - "autoit"     # ãƒãƒ«ã‚¦ã‚§ã‚¢ã®ãƒ‘ãƒƒã‚«ãƒ¼ã¨ã—ã¦ã‚ˆãä½¿ã‚ã‚Œã‚‹
      - "powershell_ise"
    noise_paths: 
      - "python/lib"
      - "python/tcl"
      - "python/include"
      - "lib/test"
      - "lib/site-packages"
      - "perl/lib"
      - "ruby/lib"
    
# ==========================================
# ğŸ›¡ï¸ NOISE FILTERS (Ignored Artifacts)
# ==========================================
noise_filters:
  # --- [User Artifacts Noise (Strong)] ---
  # ãƒ•ã‚©ãƒ«ãƒ€ãã®ã‚‚ã®(FileName)ã¨ä¸­èº«(ParentPath)ã‚’ä¸¡æ–¹æ¶ˆã™ã€ŒäºŒæ®µæ§‹ãˆã€
  - name: "Windows Sample Media (Folder)"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(Sample Music|Sample Pictures|Sample Videos)$"

  - name: "Windows Sample Media (Contents)"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)\\\\(Sample Music|Sample Pictures|Sample Videos)"

  - name: "Browser History & Cache (Folder)"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(History|Temporary Internet Files|Content\\.IE5|INetCache|Cookies)$"

  - name: "Browser History & Cache (Contents)"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)\\\\(History|Temporary Internet Files|Content\\.IE5|INetCache|Cookies)"

  - name: "Standard Temp Folders (Folder)"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(Temp|Tmp|Application Data)$"

  - name: "Standard Temp Folders (Contents)"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)\\\\(AppData\\\\Local\\\\Temp|Windows\\\\Temp)"

  - name: "Common Noisy System Folders"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(Microsoft|Windows|Internet Explorer|Quick Launch)$"

# ==========================================
# ğŸ›¡ï¸ TUNING: Additional Noise Filters (Case2_56 Fixed)
# ==========================================

  # [1] CryptnetUrlCache (è¨¼æ˜æ›¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
  # åŒºåˆ‡ã‚Šæ–‡å­—ã‚’ã€Œ.ã€ã«ã™ã‚‹ã“ã¨ã§ \ ã‚‚ / ã‚‚ç„¡è¦–ã—ã¦ãƒ’ãƒƒãƒˆã•ã›ã‚‹
  - name: 'Cryptnet Cache'
    target: 'ParentPath'
    condition: 'regex'
    pattern: '(?i)Microsoft.CryptnetUrlCache'

  # [2] Google Drive & Chrome Cache
  # é€”ä¸­ã®éšå±¤ã‚‚ .* ã§æŸ”è»Ÿã«ã‚¹ã‚­ãƒƒãƒ—
  - name: 'Google App Caches'
    target: 'ParentPath'
    condition: 'regex'
    pattern: '(?i)Google.(Drive|Chrome).*(Cache|HttpCache|TempData)'

  # [3] Skype Media Cache (ã‚µãƒ ãƒã‚¤ãƒ«ç­‰)
  - name: 'Skype Cache'
    target: 'ParentPath'
    condition: 'regex'
    pattern: '(?i)Skype.*(media_messaging|thmanager|emo_cache)'

  # [4] CLR Usage Logs (.NETå®Ÿè¡Œãƒ­ã‚°)
  # ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ [\\/] ã§æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦å›é¿
  - name: 'CLR Usage Logs'
    target: 'ParentPath'
    condition: 'regex'
    pattern: '(?i)Microsoft.CLR_v4\.0.[\\/]UsageLogs'

  # [5] Python Standard Lib (ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«)
  - name: 'Python Standard Lib'
    target: 'ParentPath'
    condition: 'regex'
    pattern: '(?i)AppData.Local.Programs.Python.Python[0-9]+'

  # [6] Windows Error Reporting (WER)
  - name: 'Windows Error Reporting'
    target: 'ParentPath'
    condition: 'regex'
    pattern: '(?i)Microsoft.Windows.WER.(ReportQueue|ReportArchive|ERC)'

  # [7] Windows Explorer Thumbnails (ã‚µãƒ ãƒã‚¤ãƒ«DB)
  # ãƒ•ã‚¡ã‚¤ãƒ«åãã®ã‚‚ã®ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹ãŸã‚å¤‰æ›´ãªã—ï¼ˆæ­£è¦è¡¨ç¾ã¯å®‰å…¨ï¼‰
  - name: 'Explorer Thumbs'
    target: 'FileName'
    condition: 'regex'
    pattern: '(?i)^thumbcache_.*\.db$'

# --- [User Artifacts Noise (Expanded)] ---
  - name: "Windows User Folders"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(My Music|My Pictures|My Videos|My Documents|Downloads|Desktop|Favorites|Links|Contacts|Searches)$"

  # --- [System Noise (Stronger)] ---
  # RACDãªã©ãŒè¦ªãƒ‘ã‚¹ã«å«ã¾ã‚Œã¦ã„ãŸã‚‰å•ç­”ç„¡ç”¨ã§æ¶ˆã™
  - name: "Reliability Analysis Component (RAC)"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)RACD"
    
  - name: "WMI & System Logs"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)(WmiApRpl|wbem\\\\Performance)"
    
  # --- [System Internals Noise] ---
  - name: "Reliability Analysis Component (RAC)"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)ServiceProfiles\\\\LocalService\\\\AppData\\\\Local\\\\Temp\\\\RACD"

  - name: "Registry Backups (RegBack)"
    target: "ParentPath"
    condition: "contains"
    pattern: "config\\RegBack"

  - name: "WMI Performance Adapter"
    target: "ParentPath"
    condition: "contains"
    pattern: "Windows\\inf\\WmiApRpl"

  - name: "WMI Repository & Logs"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)Windows\\\\System32\\\\wbem\\\\(Repository|Performance|Logs)"

  - name: "System Debug & Temp Logs"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(ChkAcc\\.bak|WRITABLE\\.TST|SCM\\.EVM.*|.*\\.OLD|.*\\.toc|.*\\.cmf|ResCache\\.dir|rc[0-9]+|ielock.*|HardAdmin.*)$"

  # --- [Existing Filters] ---
  - name: "Browser Cache (IE/Edge)"
    target: "ParentPath"
    condition: "contains"
    pattern: "Content.IE5"

  - name: "Browser Cache (General)"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)[/\\\\](INetCache|History|Cookies|Recovery|Temporary Internet Files)[/\\\\]"

  - name: "Windows Installer & Updates"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)\\\\(Windows\\\\(SoftwareDistribution|Installer|Servicing|WinSxS|assembly)|\\$Windows\\.~BT|System Volume Information)\\\\"

  - name: "Anti-Virus & System Logs"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)\\\\(ProgramData\\\\(Microsoft\\\\Windows Defender|McAfee|Symantec)|Windows\\\\System32\\\\(Msdtc|wbem\\\\Performance|LogFiles)|Windows\\\\Debug)\\\\"

  - name: "XAMPP/Database Noise"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)xampp[/\\\\]mysql[/\\\\]data"

  - name: "Forensic Tools"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)[/\\\\](Tools|ghidra|sleuthkit|FTK Imager|exiftool|Autoruns|LogFileParser|YaraRules|Strings|Splunk)[/\\\\]"

  - name: "Trusted System Paths"
    category: "Registry"
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)^(?:[a-z]:)?\\\\(Windows\\\\System32|Program Files|Program Files \\(x86\\))"

  # --- [AION Specific Noise] ---
  - name: "Windows Safe Paths"
    target: "Full_Path"
    condition: "regex"
    pattern: "(?i)\\\\(Windows\\\\(WinSxS|Servicing|SoftwareDistribution|CbsTemp|Assembly|Microsoft\\.NET\\\\Framework|System32\\\\DriverStore))"

  - name: "Known System DLLs"
    target: "Target_FileName"
    condition: "regex"
    pattern: "(?i)^(amd64_|x86_|wow64_|system\\.|microsoft\\.build).*"

  - name: "Safe Extensions"
    target: "Target_FileName"
    condition: "regex"
    pattern: "(?i)\\.(manifest|mum|cat)$"

  # --- [Extension Noise] ---
  - name: "Garbage Extensions"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)\\.(admx|adml|mum|cat|png|svg|js|json|xml|etl|evtx|log|tmp|db|dat|mui|inf|ico|css|html|htm|pf|ini|lnk|manifest|resx|nlp|pnf|cdf-ms|nls|tlb|xrm-ms|chk|trans-ms|blf|regtrans-ms|frm|ibd|opt|eot|txt)$"

  # --- [Process/File Noise] ---
  - name: "Standard Windows Processes"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(svchost\\.exe|explorer\\.exe|searchui\\.exe|taskhostw\\.exe|sihost\\.exe|conhost\\.exe|dllhost\\.exe|lsass\\.exe|winlogon\\.exe|services\\.exe|spoolsv\\.exe)$"

  - name: "Browser Processes"
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(chrome\\.exe|msedge\\.exe|firefox\\.exe|iexplore\\.exe)$"


# ==========================================
# ğŸ¦ THREAT SIGNATURES (Alerts)
# ==========================================
threat_signatures:
  # --- [AION Specific Threats] ---
  - name: "Suspicious Script Persistence"
    tag: "SCRIPT_PERSISTENCE"
    score: 40
    target: "Target_FileName"
    condition: "regex"
    pattern: "(?i)\\.(bat|ps1|vbs|hta|js|wsf)$"

  - name: "Suspicious Command in Registry"
    tag: "SUSPICIOUS_CMD"
    score: 50
    target: "Full_Path"
    condition: "regex"
    pattern: "(?i)(powershell|cmd|wscript|cscript|mshta|rundll32|regsvr32|encodedcommand)"

  - name: "WebShell (Generic Names)"
    tag: "WEBSHELL"
    score: 100
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(c99|r57|b374k|wso|shell|cmd|uploader|minishell|phpspy)[^\\.]*\\.(php|jsp|asp|aspx|cer|pl|cgi)$"

  - name: "WebShell (Broad Match)"
    tag: "WEBSHELL"
    score: 80
    target: "FileName"
    condition: "regex"
    pattern: "(?i)(c99|r57|wso|shell|cmd|uploader)[^\\\\]*\\.(php|jsp|asp|aspx)"

  - name: "Rootkit (Hacker Defender)"
    tag: "ROOTKIT"
    score: 100
    target: "FileName"
    condition: "ends_with"
    pattern: ".bud"

  - name: "Suspicious Obfuscated Script"
    tag: "OBFUSCATION"
    score: 80
    target: "FileName"
    condition: "regex"
    pattern: "(?i)(tmpudvfh|tmpbrjvl|^[a-z]{8})\\.(php|aspx)$"

  - name: "Suspicious IP Trace"
    tag: "IP_TRACE"
    score: 80
    target: "FileName"
    condition: "regex"
    pattern: "(?i)([0-9]{1,3}_[0-9]{1,3}_[0-9]{1,3}_[0-9]{1,3})"

  - name: "Script in Uploads/Temp"
    tag: "SUSPICIOUS_LOC"
    score: 80
    target: "ParentPath"
    condition: "regex"
    pattern: "(?i)\\\\(upload|temp|tmp|images|css|js)\\\\"

  - name: "Chronos High Value Targets"
    tag: "TARGET_INTEL"
    score: 100
    target: "FileName"
    condition: "regex"
    pattern: "(?i)(Secret_Project\\.pdf|Windows_Security_Audit|win_optimizer\\.lnk|SunShadow|Trigger|UpdateService\\.exe|Project_Chaos|Conf\\.7z)"

  - name: "Container Apps (LOLBINs)"
    tag: "CONTAINER"
    score: 50
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(cmd\\.exe|powershell\\.exe|pwsh\\.exe|wscript\\.exe|cscript\\.exe|mshta\\.exe|rundll32\\.exe|regsvr32\\.exe|bitsadmin\\.exe|certutil\\.exe|installutil\\.exe|psexec\\.exe|wmiprvse\\.exe|scrcons\\.exe|sh\\.exe|bash\\.exe)$"

  - name: "Suspicious Parent (Office)"
    tag: "SUSP_PARENT"
    score: 80
    target: "FileName"
    condition: "regex"
    pattern: "(?i)^(winword\\.exe|excel\\.exe|powerpnt\\.exe|outlook\\.exe)$"

    # ==========================================
# ğŸ› ï¸ Dual-Use / Admin Tools Configuration
# ==========================================
# ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã¯ã€Œæ”»æ’ƒã«ã‚‚ä½¿ã‚ã‚Œã‚‹ã€ãŸã‚ã€ã‚´ãƒŸã¯æ¶ˆã—ã¤ã¤ã€
# å®Ÿè¡Œç—•è·¡ï¼ˆEXEãªã©ï¼‰ã¯å¿…ãšå ±å‘Šæ›¸ï¼ˆLachesisï¼‰ã«æ®‹ã—ã¾ã™ã€‚
dual_use_tools:
  - name: "Nmap"
    keywords: ["nmap", "zenmap"]
    # ä»¥ä¸‹ã®ãƒ‘ã‚¹ã«å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Œãƒã‚¤ã‚ºã€ã¨ã—ã¦Chronos/Pandoraã§é™¤å¤–ã™ã‚‹
    noise_paths: ["nmap/scripts", "nmap/nselib", "nmap/docs"]

  - name: "Wireshark"
    keywords: ["wireshark", "tshark", "capinfos"]
    noise_paths: ["wireshark/snmp", "wireshark/radius", "wireshark/help", "wireshark/dtds"]

  - name: "Python / Dev Tools"
    keywords: ["python", "pip", "perl", "ruby"]
    noise_paths: ["python/lib", "python/tcl", "python/include", "lib/test", "lib/site-packages"]

  - name: "Remote Admin / Lateral"
    keywords: ["psexec", "paexec", "winscp", "putty", "netcat", "nc.exe"]
    noise_paths: [] # ãƒã‚¤ã‚ºãƒ‘ã‚¹ãªã—ï¼ˆè¦‹ã¤ã‘ãŸã‚‰å³å ±å‘Šï¼‰

  - name: "Anonymity / Tor"
    keywords: ["tor.exe", "tor browser"]
    noise_paths: ["tor/pluggabletransports"]