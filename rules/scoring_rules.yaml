# ============================================================
#  SkiaHelios Centralized Threat Scoring Rules
#  scoring_rules.yaml v2.0 (Unified)
#  Mission: Single Source of Truth for all threat scoring
#  Migrated from: sh_analyzer.py THREAT_BOOST_PATTERNS
# ============================================================

threat_scores:
  # ═══════════════════════════════════════════════════════════════
  # Anti-Forensics / Data Wiping (CRITICAL)
  # ═══════════════════════════════════════════════════════════════
  - pattern: "sdelete"
    score: 600
    tags: ["ANTI_FORENSICS", "WIPING"]
    target: "Action"
    match_mode: "contains"

  - pattern: "ccleaner"
    score: 500
    tags: ["ANTI_FORENSICS", "CLEANER"]
    target: "Action"
    match_mode: "contains"

  - pattern: "bcwipe"
    score: 600
    tags: ["ANTI_FORENSICS", "WIPING"]
    target: "Action"
    match_mode: "contains"

  - pattern: "jetico"
    score: 500
    tags: ["ANTI_FORENSICS", "WIPING"]
    target: "Action"
    match_mode: "contains"

  - pattern: "setmace"
    score: 700
    tags: ["ANTI_FORENSICS", "TIMESTOMP", "CRITICAL_TIMESTOMP"]
    target: "Action"
    match_mode: "contains"

  - pattern: "timestomp"
    score: 700
    tags: ["ANTI_FORENSICS", "TIMESTOMP"]
    target: "Action"
    match_mode: "contains"

  - pattern: "cipher.exe"
    score: 600
    tags: ["ANTI_FORENSICS", "WIPING", "WIPING_TOOL"]
    target: "FileName"
    match_mode: "endswith"

  - pattern: "vssadmin.exe"
    score: 600
    tags: ["ANTI_FORENSICS", "SHADOW_COPY_KILLER"]
    target: "FileName"
    match_mode: "endswith"

  - pattern: "wbadmin.exe"
    score: 600
    tags: ["ANTI_FORENSICS", "BACKUP_DESTRUCTION"]
    target: "FileName"
    match_mode: "endswith"

  - pattern: "attributedialog"
    score: 800
    tags: ["ANTI_FORENSICS", "ADS_CREATION"]
    target: "Action"
    match_mode: "contains"

  # ═══════════════════════════════════════════════════════════════
  # Credential Dumping
  # ═══════════════════════════════════════════════════════════════
  - pattern: "mimikatz"
    score: 800
    tags: ["CREDENTIAL_THEFT", "MIMIKATZ"]
    target: "Action"
    match_mode: "contains"

  - pattern: "lazagne"
    score: 700
    tags: ["CREDENTIAL_THEFT", "LAZAGNE"]
    target: "Action"
    match_mode: "contains"

  - pattern: "procdump"
    score: 500
    tags: ["CREDENTIAL_THEFT", "PROCDUMP", "CREDENTIAL_DUMP"]
    target: "Action"
    match_mode: "contains"

  - pattern: "hash_suite"
    score: 500
    tags: ["CREDENTIAL_THEFT", "HASH_CRACKER"]
    target: "Action"
    match_mode: "contains"

  # ═══════════════════════════════════════════════════════════════
  # Lateral Movement
  # ═══════════════════════════════════════════════════════════════


  - pattern: "wmiexec"
    score: 500
    tags: ["LATERAL_MOVEMENT", "IMPACKET"]
    target: "Action"
    match_mode: "contains"

  - pattern: "secretsdump"
    score: 700
    tags: ["LATERAL_MOVEMENT", "IMPACKET", "CREDENTIAL_THEFT"]
    target: "Action"
    match_mode: "contains"

  # ═══════════════════════════════════════════════════════════════
  # Exploitation Frameworks / Webshells
  # ═══════════════════════════════════════════════════════════════
  - pattern: "metasploit"
    score: 500
    tags: ["EXPLOIT_FRAMEWORK", "METASPLOIT"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "back_door.rb"
    score: 800
    tags: ["EXPLOIT_FRAMEWORK", "METASPLOIT", "METASPLOIT_SCRIPT"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "exploit."
    score: 800
    tags: ["EXPLOIT_FRAMEWORK", "METASPLOIT", "METASPLOIT_FRAMEWORK"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "meterpreter"
    score: 600
    tags: ["C2", "METERPRETER"]
    target: "FileName"
    match_mode: "contains"

  # WebShell patterns - require file extension or word boundary to avoid hex hash false positives
  # NG: ...abc99def... (part of hash)  OK: c99.php, web_c99.php, c99shell.asp
  - pattern: "(?i)(^|[^0-9a-f])c99([^0-9a-f]|\\.(php|asp|aspx|jsp|cgi|pl))"
    score: 800
    tags: ["WEBSHELL", "CRITICAL_WEBSHELL"]
    target: "FileName"
    match_mode: "regex"
    description: "c99 WebShell - classic PHP backdoor"

  - pattern: "webshell"
    score: 800
    tags: ["WEBSHELL", "CRITICAL_WEBSHELL"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "phpshell"
    score: 800
    tags: ["WEBSHELL", "CRITICAL_WEBSHELL"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "b374k"
    score: 800
    tags: ["WEBSHELL", "CRITICAL_WEBSHELL"]
    target: "FileName"
    match_mode: "contains"

  # r57 also needs hex exclusion - same issue as c99
  - pattern: "(?i)(^|[^0-9a-f])r57([^0-9a-f]|\\.(php|asp|aspx|jsp|cgi|pl))"
    score: 800
    tags: ["WEBSHELL", "CRITICAL_WEBSHELL"]
    target: "FileName"
    match_mode: "regex"
    description: "r57 WebShell - classic PHP backdoor"


  # ═══════════════════════════════════════════════════════════════
  # Sysinternals / Admin Tools (Context-Aware)
  # ═══════════════════════════════════════════════════════════════
  - pattern: "sync.exe"
    score: 300
    tags: ["SYSINTERNALS_SYNC"]
    target: "FileName"
    match_mode: "exact"

  - pattern: "sync64.exe"
    score: 300
    tags: ["SYSINTERNALS_SYNC"]
    target: "FileName"
    match_mode: "exact"

  - pattern: "robocopy.exe"
    score: 100
    tags: ["ADMIN_TOOL", "FILE_COPY_TOOL"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "xcopy.exe"
    score: 100
    tags: ["ADMIN_TOOL", "FILE_COPY_TOOL"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "wmic.exe"
    score: 100
    tags: ["ADMIN_TOOL", "WMI_EXECUTION"]
    target: "FileName"
    match_mode: "contains"

  # ═══════════════════════════════════════════════════════════════
  # Remote Access / Tunneling
  # ═══════════════════════════════════════════════════════════════
  - pattern: "putty"
    score: 300
    tags: ["REMOTE_ACCESS", "SSH"]
    target: "Action"
    match_mode: "contains"

  - pattern: "winscp"
    score: 300
    tags: ["REMOTE_ACCESS", "SSH"]
    target: "Action"
    match_mode: "contains"

  - pattern: "pscp"
    score: 300
    tags: ["REMOTE_ACCESS", "SSH"]
    target: "Action"
    match_mode: "contains"

  - pattern: "plink"
    score: 300
    tags: ["REMOTE_ACCESS", "SSH"]
    target: "Action"
    match_mode: "contains"

  - pattern: "ssh-add"
    score: 350
    tags: ["REMOTE_ACCESS", "SSH"]
    target: "Action"
    match_mode: "contains"

  - pattern: "chisel"
    score: 500
    tags: ["TUNNELING", "C2"]
    target: "Action"
    match_mode: "contains"

  - pattern: "ngrok"
    score: 400
    tags: ["TUNNELING", "PROXY"]
    target: "Action"
    match_mode: "contains"

  - pattern: "ligolo"
    score: 500
    tags: ["TUNNELING", "C2"]
    target: "Action"
    match_mode: "contains"

  # ═══════════════════════════════════════════════════════════════
  # Lateral Movement / UNC Paths
  # ═══════════════════════════════════════════════════════════════
  - pattern: "^\\\\\\\\[^\\\\]+\\\\"
    score: 150
    tags: ["LATERAL_MOVEMENT", "UNC_EXECUTION"]
    target: "Action"
    match_mode: "regex"
    description: "UNC path execution (\\\\server\\share)"

  - pattern: "psexec"
    score: 300
    tags: ["LATERAL_MOVEMENT", "PSEXEC"]
    target: "Action"
    match_mode: "contains"
    negative_context:
      - path_contains: "sysinternals"
      - path_contains: "program files"

  # ═══════════════════════════════════════════════════════════════
  # Data Exfiltration
  # ═══════════════════════════════════════════════════════════════
  - pattern: "rclone"
    score: 600
    tags: ["EXFILTRATION", "CLOUD_SYNC"]
    target: "Action"
    match_mode: "contains"

  - pattern: "megacmd"
    score: 600
    tags: ["EXFILTRATION", "CLOUD_SYNC"]
    target: "Action"
    match_mode: "contains"

  - pattern: "dd.exe"
    score: 900
    tags: ["EXFILTRATION", "DATA_EXFIL_TOOL"]
    target: "FileName"
    match_mode: "endswith"

  # ═══════════════════════════════════════════════════════════════
  # Recon / Scanning / Forensic Tools
  # ═══════════════════════════════════════════════════════════════
  - pattern: "nmap"
    score: 200
    tags: ["INTERNAL_RECON", "SCANNER"]
    target: "Action"
    match_mode: "contains"

  - pattern: "sharphound"
    score: 600
    tags: ["INTERNAL_RECON", "BLOODHOUND"]
    target: "Action"
    match_mode: "contains"

  - pattern: "bloodhound"
    score: 600
    tags: ["INTERNAL_RECON", "BLOODHOUND"]
    target: "Action"
    match_mode: "contains"

  - pattern: "dcode"
    score: 400
    tags: ["FORENSIC_TOOL"]
    target: "Action"
    match_mode: "contains"

  # ═══════════════════════════════════════════════════════════════
  # Staging / Archive Tools
  # ═══════════════════════════════════════════════════════════════
  - pattern: "7za.exe"
    score: 600
    tags: ["STAGING", "ARCHIVE", "STAGING_TOOL"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "7z.exe"
    score: 300
    tags: ["STAGING", "ARCHIVE"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "rar.exe"
    score: 300
    tags: ["STAGING", "ARCHIVE"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "choco.exe"
    score: 400
    tags: ["STAGING", "STAGING_TOOL"]
    target: "FileName"
    match_mode: "contains"

  # ═══════════════════════════════════════════════════════════════
  # UNC Path Execution (Network Share)
  # ═══════════════════════════════════════════════════════════════
  - pattern: "\\\\\\\\"
    score: 150
    tags: ["UNC_EXECUTION", "NETWORK_SHARE"]
    target: "Target_Path"
    match_mode: "startswith"

  # ═══════════════════════════════════════════════════════════════
  # [Case 9 Fix] Encryption / Privacy Tools (Insider Threat)
  # ═══════════════════════════════════════════════════════════════
  - pattern: "aescrypt"
    score: 400
    tags: ["ENCRYPTION_TOOL", "INSIDER_THREAT"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "kleopatra"
    score: 450
    tags: ["ENCRYPTION_TOOL", "GPG_TOOL", "INSIDER_THREAT"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "gpg.exe"
    score: 400
    tags: ["ENCRYPTION_TOOL", "GPG_TOOL"]
    target: "FileName"
    match_mode: "endswith"

  - pattern: "gpg4win"
    score: 400
    tags: ["ENCRYPTION_TOOL", "GPG_SUITE"]
    target: "Action"
    match_mode: "contains"

  - pattern: "veracrypt"
    score: 500
    tags: ["ENCRYPTION_TOOL", "CONTAINER_ENCRYPTION"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "truecrypt"
    score: 500
    tags: ["ENCRYPTION_TOOL", "CONTAINER_ENCRYPTION", "LEGACY"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "bitlockerwizard"
    score: 500
    tags: ["ENCRYPTION_TOOL", "BITLOCKER"]
    target: "FileName"
    match_mode: "contains"

  - pattern: ".aes"
    score: 500
    tags: ["ENCRYPTED_FILE", "AES"]
    target: "FileName"
    match_mode: "endswith"

  - pattern: ".gpg"
    score: 450
    tags: ["ENCRYPTED_FILE", "GPG"]
    target: "FileName"
    match_mode: "endswith"

  - pattern: ".asc"
    score: 450
    tags: ["ENCRYPTED_KEY", "GPG"]
    target: "FileName"
    match_mode: "endswith"

  - pattern: ".vhd"
    score: 350
    tags: ["VIRTUAL_DISK", "HIDDEN_VOLUME"]
    target: "FileName"
    match_mode: "endswith"

  - pattern: "recovery key"
    score: 700
    tags: ["RECOVERY_KEY", "CRITICAL"]
    target: "FileName"
    match_mode: "contains"

  - pattern: "回復キー"
    score: 700
    tags: ["RECOVERY_KEY", "CRITICAL", "JP"]
    target: "FileName"
    match_mode: "contains"

# ═══════════════════════════════════════════════════════════════
# UNC Lateral Movement Tool List (for context boost)
# ═══════════════════════════════════════════════════════════════
unc_lateral_tools:
  - "dcode"
  - "robocopy"
  - "xcopy"
  - "psexec"
  - "wmic"
  - "sync"
  - "bcwipe"
  - "dd.exe"
  - "putty"
  - "plink"
  - "ssh"

# ═══════════════════════════════════════════════════════════════
# Garbage / Noise Patterns (for filtering)
# ═══════════════════════════════════════════════════════════════
garbage_patterns:
  - "windows\\winsxs"
  - "windows\\assembly"
  - "windows\\microsoft.net"
  - "windows\\servicing"
  - "windows\\systemapps"
  - "windows\\inf"
  - "windows\\driverstore"
  - "driverstore"
  - "windows\\diagtrack"
  - "windows\\biometry"
  - "windows\\softwaredistribution"
  - "program files\\windowsapps"
  - "windowsapps"
  - "deletedalluserpackages"
  - "\\apprepository"
  - "\\contentdeliverymanager"
  - "\\infusedapps"
  - "system32\\driverstore"

# ═══════════════════════════════════════════════════════════════
# Context Boost Patterns (Admin Share Access)
# ═══════════════════════════════════════════════════════════════
context_boosts:
  admin_share_keywords:
    - "ADMIN$"
    - "C$"
    - "D$"
    - "IPC$"
  boost_score: 200
  description: "Boost when accessing admin shares"
